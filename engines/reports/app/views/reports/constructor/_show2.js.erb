<% @alpaca_raw_json.each do |key, value| %>
  var <%= key %> =  <%= raw value.to_json %>;
<% end %>
$("#main-form").alpaca({
    "data": {
    },
    "schema": {
        "type": "object",
        "properties": {
              "class_name":{
                "title": '<%= t(".class_name") %>',
                "enum": class_options,
                "required": true
              },
              "attributes":{
                "title": '<%= t(".attributes") %>',
                "type":'string',
                "required": true
              },
              "associations":{
                "title": '<%= t(".tables") %>',
                "type": "array",
                // "required": true,
                "items": {
                  "type": "object",
                  "properties": {
                    "associations":{
                      "type":"array"
                    },
                    "association":{
                      "title": '<%= t(".associations") %>',
                      "required": true
                  //   }
                  // }
                },
                // "minItems": 2,
                // "maxItems": 1
              }


        }
    },
    "options":{
      "focus":"",
      "hideInitValidationError":true,
      "fields":{
            "class_name":{
              "type": "select",
              "optionLabels": class_labels,
              "onFieldChange": function(e) {
                $.getJSON( "<%= attributes_constructor_index_path %>", { class_name: this.getValue()} )
                  .done(function( json ) {
                    var al = $("#main-form").alpaca('get').getControlByPath('attributes');
                    al.schema.enum = json.attributes;
                    al.options.optionLabels = json.types;
                    al.setValue('');
                    al.refresh();

                    // var al = $("#main-form").alpaca('get').getControlByPath('associations/association');
                    // al.schema.items.enum = json.associations;
                    // al.options.fields.item.optionLabels = json.associations_labels;
                    // al.setValue('');
                    // al.refresh();
                  });
              }
            },
            "attributes":{
              "type": "chooser"
            },
            // "associations":{
            //   "type": "array",
            //   "actionbar": {
            //     "actions": [{
            //         "action": "up",
            //         "enabled": false
            //       },
            //       {
            //         "action": "down",
            //         "enabled": false,
            //       },
            //       {
            //         "action": "add",
            //         "enabled": true
            //       }
            //
            //
            //     ]
            //   },
            //   "items": {
            //     "fields":{
            //       "association":{
            //         "type": "select",
            //         "onFieldChange": function(e) {
            //           // var this.schema.items = {
            //           //   "title": '<%= t(".class_name") %>',
            //           //   "required": true
            //           // }
            //           // alert('sss');
            //         }
            //       }
            //     }
            //
            //   }
            //
            // }

      },
      "form": {
            "attributes": {
                "method": "post",
                "action": "action"
            },
            "buttons": {
                "submit": {
                    "title": '<%= t(".build") %>',
                    "click": function() {
                       this.validate(true);
                       this.refreshValidationState(true);
                       if (!this.isValid(true)) {
                           return;
                       }
                    }
                }
        }
    },
    "view": {
        "layout": {
            "template": "<%=j render partial: 'form_layout' %>",
            "bindings": {
                "class_name": "column-1",
                "tables": "column-1",
                "attributes" : "column-2"
            }
        }
    }

  },
  "postRender": function(control) {
    apply_select();
     $("#main-form").alpaca('get').getControlByPath('class_name').getControlEl().trigger('change');

}});
