# Краткое описание
Модуль позволяет работать пользователю с несколькими разными облаками
в едином интерфейсе. На данный момент поддерживаются облака под управлением
Opennebula.

Самыми главными сущностями являются шаблоны, по которым для пользователей создаются
виртуальные машины. Каждый шаблон в Octoshell связан с шаблоном в Opennebula.
Шаблоны объединяются в типы и имеют записи о ресурсах, таких как число
процессоров, объём ОЗУ и жёсткого диска, доступ в Интернет и т.д.

Пользователи создают заявки на виртуальные машины, которые в случае одобрения
будут созданы по  шаблонам Octoshell. В своих заявках пользователи могут
редактировать ресурсы, если администратор сделал их редактируемыми в шаблонах.

После того, как пользователь отправил заявку на рассмотрение, администратор
может принять её или отклонить. В случае принятия администратор может изменить
конфигурацию виртуальных машин в заявке, после чего новые виртуальные машины
добавляются к уже одобренному доступу для проекта, если он есть, иначе для него
создаётся новый. Допускается подавать заявки на ресурсы для уже работающих
виртуальных машин.

Доступ может находиться в одном из нескольких состояний:
1. Новый -- доступ пока формируется, в облаках виртуальные машины пока не созданы.
2. Одобрен -- Пользователю разрешено работать с его виртуальными машинами.
При переходе в данное состояние посылается автоматизированный запрос в Opennebula
и допускается синхронизация с облаком, если в доступе появились новые виртуальные машины
или были изменены старые. Для каждого проекта в один момент времени может
существовать только один одобренные доступ, это сделано для удобства пользователей.
3. Подготовлен к завершению администратором, подготовлен к завершению --
в этих состояниях у пользователя изымаются его виртуальные машины, но данные
на жёстких дисках пока не стираются.
Различаются эти состояния только тем, кто инициировал этот процесс:
администратор или пользоватеть.
4. Отказано в доступе, завершён -- В этом состоянии у пользователя стираются
все данные на жёстких дисках (в облаке).
В состояния "Отказано в доступе"и "завершён"
администратор переводит доступы из состояний "Подготовлен к завершению администратором" и
"Подготовлен к завершению" соответственно.

# Интерфейс администратора
В этом разделе администратор может познакомиться с основными сущностями подробнее, а также раздел представляет пошаговую инструкцию для заполнения облака необходимой информацией.
## Виды шаблонов
Прежде всего необходимо создать виды шаблонов.
Виды шаблонов можно организовывать в иерархии. В модуле можно редактировать как
все иерархии одновременно с помощью кнопки "редактировать дерево", так и по отдельности.
Пояснения требует атрибут "Тип на кластере". Он отвечает за то, как именно будет
обрабатываться шаблон и единицы, созданные по его подобию, на облачном кластере.
На данный момент доступен только тип на кластере "Виртуальная машина".
Для простоты далее будет называть этот тип шаблона "Виртуальная машина".
тип шаблона "Виртуальная машина". можно создать только один.
Те шаблоны, которые принадлежат такому типу  шаблона  или его потомку,
связаны с шаблонами Opennebula атрибутом cloud_id(identity), об этом будет
сказано далее в  соответствующем разделе. По этой же причине на странице данного
типа шаблона  будет доступна кнопка для загрузки шаблонов из облака, но её
пока лучше не трогать.
## Виды ресурсов
Видом ресурсов могут быть число процессоров, ОЗУ, объём жёсткого диска, доступ в интернет и так далее.
В шаблоне можно указать какие ресурсы являются редактируемыми в заявках пользователей,
а какие -- нет. Каждый ресурс шаблона должен иметь свой тип ресурсов, который соответствует типу шаблона.   

Нужные типы ресурсов, скорее всего, были уже созданы. Приступим к их редактированию!
Атрибут identity отвечает за то, как ресурсы этого типа будут обрабатываться
в облаке, его лучше лишний раз не менять. Тип значения влияет на представление
атрибута в Octoshell, его тоже лишний раз не менять. Атрибут единица -- это
подсказка пользователю о единицы измерения. Его изменение никак не повлияет
на поведение скрипта: что считалось гигабайтами, ими и останется.
Возможно понадобится изменение атрибутов "имя  и "помощь в заполнении".
Помощь в заполнении показывается пользователю при редактировании заявки на
виртуальную машину.  

## Облака
Каждый шаблон принадлежит одному из облак. Именно в облаке содержится
информация о подключении. На данный момент поддерживаются только облака типа
Opennebula. Для Opennebula необходимо заполнить id сетей для внутренней сети и
сети для подключения к Интернету.

## Шаблоны
Ура, теперь можно создавать шаблоны в Octoshell!
Можно наконец нажать кнопку для загрузки шаблонов на странице типа шаблона:
ведь у нас есть нужные типы ресурсов и информация о них автоматически будет
загружена из Opennebula! Octoshell пройдётся по всем облакам и
загрузит в систему все шаблоны. Но перед их использованием пользователями
необходимо их отредактировать.

Перейдем к редактированию шаблонов. В каждом шаблоне зафиксированы id в облаке
и само облако, к которому оно принадлежит. Допускается создавать несколько
шаблонов Octoshell, связанных с одним и тем же шаблоном в Opennebula, но
такие шаблоны придётся создавать с нуля, без импорта из облака.
Название, описание и ресурсы могут свободно редактироваться.
При редактировании автоматически добавляются новые ресурсы тех типов,
которые ещё не были представлены. Ресурсы можно удалить с помощью галочки
"Удалить", у новых ресурсов она автоматически выставлена. Для того, чтобы
ресурс можно было редактировать пользователю в пределах от мин до макс, нужно
выставить галку "Пользователь может редактировать". В случае
если ресурса для шаблона Octoshell не существует, то это к ошибке не приведёт:
например, если не указано число процессоров, то это число возьмётся из
шаблона Opennebula.
Но на данный момент пользователь пока не может добавлять их в свою заявку: нужно
выставить галочку "Подавать новые заявки". Убрав её, администратор может запретить
подавать новые заявки к шаблону, существующие заявки и доступы c виртуальными машинами,
созданными по этому шаблону, не пострадают.

## Заявки
Чтобы одобрить заявку, на её странице необходимо нажать кнопку
"создать доступ из заявки". Если для проекта ещё нет одобренного доступа,
он будет создан, иначе -- виртуальные машины будут добавлены к
существующему одобренному доступу. В появившейся форме можно изменить
добавляемые (изменяемые) виртуальные машины. Новые виртуальные машины находятся
в своей секции, заявки на изменение сущетсвующим ВМ -- в своей.
После сохранения формы заявка становится одобренной.

На странице заявки отображаются виртуальные машины и их РЕДАКТИРУЕМЫЕ ресурсы.
Если редактируемый ресурс относится уже существующей ВМ в одобренном доступе,
то зелёным цветом обозначается новое значение, красным -- старое.


## Доступы
Доступ для пользователя администратор может создать двумя способами:
с помощью заявки пользователя или сразу, нажав на кнопку "новый" на странице
списка доступов. Администратор при редактировании доступа (или добавление новых ВМ)
никак не скован ограничениями на ресурсы, заданными в шаблоне. Если доступ имеет статус
"новый" он может быть слит с другими доступами.

После одобрения доступа запускается синхронизация с облаком. Это означает, что
описание ВМ в облаке будет приводиться к его описанию в Octoshell. На странице
доступа записывается дата и время начала и конца последней синхронизации.
Если, например, спустя 5 минут синхронизация до сих пор не завершилась, то это
может свидетельствовать о критичесчкой ошибке в Octoshell или в Opennebula:
некритические ошибки, как правило, просто записываются в логи виртуальной машины.
Синхронизация одобренного доступа может быть запущены администратором в любой момент
времени.

Для того, чтобы обновить состояния всех виртуальных машин доступа, достаточно
нажать соответствующую кнопку. Эта операция не считается за синхронизацию,
поэтому дата и время не записываются.

Для каждой виртуальной машины пишутся логи. Каждая синхронизация
разбивается на несколько команд Opennebula, и их результаты пишутся в логи.
Если команда выполняется неудачно, то необходимо разобрать почему она
не выполнилась. Логи доступны для каждой ВМ на странице доступа.

На странице доступа зелёным обозначаются новые значения для редактируемых
ресурсов из одобренных заявок, красным -- старые.
После удачной синхронизации значения приобретают черный цвет, красные - удаляются.

# Интерфейс пользователя
Только менеджер активного проекта может подавать заявки на виртуальные машины.
Изменять доступ могут только менеджеры проекта, смотреть информация
о доступе могут все участники проекта. При этом добавятся на виртуальные машины
только  активные ssh-ключи активных пользователей проекта.
## Создание заявки
До того, как заявка будет отправлена на рассмотрение (для этого надо нажать на
соответствующую кнопку) она может редактироваться пользователем.
В разделе шаблоны облачного кластера доступны все "разрешённые" шаблоны
виртуальных машин. Редактируемые ресурсы пользоватеть может изменять в заявке.

Заявка состоит из позиций. Добавить их можно несколькими способами:
1. На странице шаблона пользователь может нажать кнопку "добавить в заявку",
после чего отредактировать ресурсы и нажать кнопку сохранить.
2. На странице редактирования заявки копировать другие позиции или создавать новые.
3. На странице доступа нажать "запрос на изменение существующих единиц",
 после чего отредактировать ресурсы и нажать кнопку сохранить. Такая позиция
 будет добавлена в раздел "Запрос на изменение существующих единиц".

После составления заявки её можно отправить на рассмотрение. До этого к новой
заявке можно перейти через раздел "заявки" или по кнопке "новая заявка".

## Доступ
В один момент времени у проекта может быть максимум один одобренный доступ.
Если для доступа созданы виртуальные машины, то информация о них (id, название и др.)
будут показаны на странице одобренного доступа.
