# Заметки о программировании в Octoshell

Здесь собраны некоторые заметки об устройстве Octhoshell, возможно, не полные.

# Как устроен Octoshell

Octoshell - приложение на Runy-on-Rails. Почти вся функциональность вынесена в
модули (engines). В основном приложении находится модель User, позволяющая
регистрироваться в Octoshell и выполнять минимальные действия. Ключевые модули -
Core (содержит понятия "проект", "кластер" и т.п.) и Face (содержит основной
шаблон страницы и интерфейс к главному меню).

# Интерфейс

Во view используется шаблонизатор slim. Допускается использование других (erb 
и т.п.), но не приветствуется. Уже подключены Bootstrap 5, JQuery, FontAwesome -
их использование приветствуется.

## Автодополнения

Пример поля с автодополнением выбора пользователя:

```
  = f.autocomplete_field :id, label: t("user"), source: main_app.users_path
```

Для реализации в контроллере (если хотите предоставить автодополнение своих
моделей) используйте код по примеру User:

```
  # User - замените на свою модель
  # format.json - необходимо для механизма автодополнения
  format.json do
    @users = User.finder(params[:q])
    
    # проверка прав, не-суперадминам данные выдаются в урезанном виде
    # это не обязательно. Важно: поля records=список_записей и total: число записей

    if User.superadmins.include? current_user
      render json: { records: @users.page(params[:page]).per(params[:per]),
                     total: @users.count }
    else
      render json: { records: @users.page(params[:page]).per(params[:per])
                                    .map{ |u| { id: u.id,
                                                text: u.full_name_with_cut_email }},
                     total: @users.count }
    end
  end
```

## Flash-оповещения

Чтобы вывести пользователю короткое сообщение на страничке при следующем
обращении (если далее будет вызван redirect_to, например) или текущем (перед
вызовом render и т.п.) нужно воспользоваться одним из хелперов:

```
  flash_message TYPE, message      # для следующего обращения
  flash_now_message TYPE, message  # для текущего обращения
```

Здесь TYPE определяет оформление (css-стиль), рекомендуются значения 'success',
'ok', 'error', 'danger', 'alert', 'warn', 'warning', 'notice', 'info'. Иные
значения будут интерпретированы как явное имя css-класса.

Несколько вызовов хелпера выведут несколько сообщений (поэтому
**не пишите в flash напрямую!**). Текст сообщения не фильтруется на предмет
html-разметки, поэтому можно вставлять ссылки и т.п. а также соблюдать
осторожность при выводе сообщений, составленных пользователем.

## Оповещения (Notify)

Класс Notify определён в модуле Core. Он содержит поля:

- message:        текст
- count:          число копий уведомления (опционально)
- category:       0=уведомление для одного пользователя, 1=широковещательное, другое=по умолчанию не показывать
- kind:           строка (или nil) для выбора обработчика. nil = просто показать
- show_from:      nil или время с которого показывать уведомление
- show_till:      nil или время до которого показывать уведомление
- active:         nil/int. 0 = не показывать (nil/1 = показываем)
- sourceable:     объект, к которому привязано оповещение (обычно пользователь, для category=0 обязательно пользователь)
- linkable:       связанный объект (опционально)

В ROOT/config/initializers/notice.rb (или в ином месте) можно зарегистрировать обработчик
определённого типа (kind) сообщений:

```
Core::Notice.register_kind 'mykind' do |notice, user, params, request|
  # nil
  # [:warn, "Your account is blocked now. Please, contact administrator here #{notice.message}."]
end
```

Обработчик принимает строку с типом оповещений и блок. Блок вызывается для проверки
того, надо ли показывать уведомление. Онвозвращает либо nil (не показывать), либо
массив из двух элементов: стиль уведомления ('success', 'ok', 'error', 'danger',
'alert', 'warn', 'warning', 'notice', 'info', либо явное имя css-стиля) и текст.
**Внимание!** текст будет показан с интерпретацией всех html-тегов!
